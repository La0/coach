{% extends 'base.html' %}

{% set page_title = post and _('Edit %s') % post.title or _('Create a post') %}

{% block js %}
<script type="text/javascript">
$(function(){

  // Setup quill editor
  var editor = new Quill('#text_editor', {
    formats: ['bold', 'italic', 'strike', 'underline', 'bullet', 'list', 'link'],
    styles : false,
    pollInterval : 50,
    modules : {
      'toolbar': { container: '#toolbar' },
      'link-tooltip': true
    }
  });
  editor.setHTML('{{ form.html.value()|default('')|safe }}');
  
  // Focus on box click
  $('#text_editor').on('click', function(){
    editor.focus();
  });

  // Submit with html content
  $('button#edit').on('click', function(evt){

    // Load form data
    var data = serialize_form($('#post_editor'), evt);

    // Add editor html
    data['html'] = editor.getHTML();

    // Submit form
    load_box(this.getAttribute('action'), 'POST', data, null);
  });

  {% if post %}
  // Image upload through DropZone
  $("div#dropzone").dropzone({
    url: "{% url 'post-upload' post.slug %}",
    headers : {
      'X-CSRFToken' : '{{ csrf_token }}',
    },
  });
  {% endif %}
});
</script>
{% endblock %}

{% block content %}
<div class="container">

  {% if post %}
  <h1>{{ _('Edit post : %s') % post.title }}</h1>
  {% else %}
  <h1>{{ _('Create a post') }}</h1>
  {% endif %}

  <form class="form-horizontal" method="post" action="{% if post %}{% url 'post-edit' post.slug %}{% else %}{% url 'post-create' %}{% endif %}" id="post_editor">
    {% csrf_token %}
    {{ macros.input(form.title) }}
    {{ macros.input(form.slug) }}
    {{ macros.input(form.type) }}
    {{ macros.input_bool(form.published) }}
  </form>

  <div class="form-group">
    <div id="toolbar">
      <div class="btn-group">
        <button class="ql-bold do-tooltip btn btn-default" title="{{ _('Bold (Ctrl+B)') }}">
          <i class="icon-bold"></i>
        </a>
        <button class="ql-italic do-tooltip btn btn-default" title="{{ _('Italic (Ctrl+I)') }}">
          <i class="icon-italic"></i>
        </a>
        <button class="ql-strike do-tooltip btn btn-default" title="{{ _('Strikethrough') }}">
          <i class="icon-strike"></i>
        </a>
        <button class="ql-underline do-tooltip btn btn-default" title="{{ _('Underline (Ctrl+U)') }}">
          <i class="icon-underline"></i>
        </a>
      </div>

      <div class="btn-group">
        <button class="ql-bullet do-tooltip btn btn-default" title="{{ _('Bullet list') }}">
          <i class="icon-list"></i>
        </a>
        <button class="ql-list do-tooltip btn btn-default" title="{{ _('Numbered list') }}">
          <i class="icon-list-numbered"></i>
        </a>
      </div>

      <button class="ql-link do-tooltip btn btn-default" title="{{ _('External link') }}">
        <i class="icon-link"></i>
      </a>
    </div>

    <div id="text_editor" class="col-xs-12">
    </div>
  </div>

  <p>
    <a href="{% url 'posts' %}" class="btn btn-default">{{ _('Cancel') }}</a>
    <button id="edit" type="submit" class="btn btn-primary">{% if post %}{{ _('Edit the post') }}{% else %}{{ _('Create the post') }}{% endif %}</button>
    {% if post %}
    <a href="{% url 'post' user.username, post.slug %}" class="btn btn-info">{{ _('View the post') }}</a>
    {% endif %}
  </p>

  {% if post %}
  <hr />
  
  {% if images %}
  <div class="row" id="medias">
    {% for thumb in images %}
    <div class="col-sm-3 col-xs-6">
      <div class="thumbnail">
        <img class="img-responsive" src="{{ thumb.url }}" alt="{{ thumb.fullname }}" />
        <div class="caption">
          {% if thumb.fullname %}
          <h4>{{ thumb.fullname }}</h4>
          {% endif %}
          <p class="text-right">
            <a href="#" class="btn btn-primary btn-sm" role="button">{{ _('Edit') }}</a>
            <a href="{% url 'post-media-delete' thumb.parent.pk %}" class="btn btn-danger btn-sm modal-action" role="button">{{ _('Delete') }}</a>
          </p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="text-info">
    {{ _('Use the zone below to add some pictures') }}
  </p>
  {% endif %}
  <div id="dropzone" class="dropzone"></div>

  <hr />
  <div class="box" data-src="{% url 'post-sessions' post.slug %}">{{ _('Loading sessions...') }}</div>
  {% endif %}
</div>
{% endblock %}
